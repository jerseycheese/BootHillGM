# Player Decision Tracking System

## Overview

The Player Decision Tracking System is a core component of the narrative system in BootHillGM. It is designed to:

-   Present decision points to the player.
-   Record the player's choices.
-   Store the history of player decisions.
-   Calculate the relevance of decisions over time.
-   Make decision history available for influencing future narrative content (e.g., AI-generated responses).

## Data Structures

The system uses the following key data structures, defined in `BootHillGMApp/app/types/narrative.types.ts`:

-   **`DecisionImportance`**:  An enum representing the importance of a decision (`critical`, `significant`, `moderate`, `minor`).

-   **`PlayerDecisionOption`**: Represents a single option within a decision.
    -   `id`: Unique identifier (string).
    -   `text`: Display text for the option (string).
    -   `impact`: Description of the potential impact (string).
    -   `tags`: Optional tags for categorization (string[]).

-   **`PlayerDecision`**: Represents a decision point presented to the player.
    -   `id`: Unique identifier (string).
    -   `prompt`: Text prompt describing the decision (string).
    -   `timestamp`: When the decision was presented (number).
    -   `location`: Where the decision took place (`LocationType`, optional).
    -   `options`: Available options (`PlayerDecisionOption[]`).
    -   `context`: Narrative context when the decision was presented (string).
    -   `importance`: Significance of the decision (`DecisionImportance`).
    -   `characters`: Characters involved in the decision (string[], optional).
    -   `aiGenerated`: Whether the decision was generated by AI or predefined (boolean).

-   **`PlayerDecisionRecord`**: Represents a record of a player's choice.
    -   `decisionId`: Reference to the original `PlayerDecision` (string).
    -   `selectedOptionId`: ID of the chosen option (string).
    -   `timestamp`: When the decision was made (number).
    -   `narrative`: Narrative response after the decision (string).
    -   `impactDescription`: Description of the impact (string).
    -   `tags`: Tags for categorization and filtering (string[]).
    -   `relevanceScore`: Dynamically calculated relevance score (0-10) (number).
    -   `expirationTimestamp`: Optional timestamp when the decision becomes less relevant (number).

## Utility Functions

The following utility functions are defined in `BootHillGMApp/app/utils/decisionUtils.ts`:

-   **`createDecision(prompt, options, context, importance, location?, characters?)`**: Creates a new `PlayerDecision` object.
-   **`createDecisionOption(text, impact, tags?)`**: Creates a new `PlayerDecisionOption` object.
-   **`createDecisionRecord(decision, selectedOptionId, narrative)`**: Creates a `PlayerDecisionRecord` object when a player makes a choice.  Calculates an initial `relevanceScore` based on the decision's `importance`.
-   **`formatDecisionsForAIContext(decisions, maxDecisions?)`**: Formats decision history for inclusion in AI context prompts.
-   **`hasDecisionExpired(decision)`**: Checks if a decision record has expired based on its `expirationTimestamp`.
-   **`filterRelevantDecisions(decisions, currentTags?, minRelevance?)`**: Filters decision records based on relevance score, expiration, and optional tags.

## Reducer Actions

The `narrativeReducer` in `BootHillGMApp/app/reducers/narrativeReducer.ts` handles the following decision-related actions:

-   **`PRESENT_DECISION`**: Updates the `currentDecision` property in the `NarrativeState` with the provided `PlayerDecision`.
-   **`RECORD_DECISION`**: Creates a `PlayerDecisionRecord` using `createDecisionRecord` and adds it to the `decisionHistory` array in the `NarrativeContext`. Clears the `currentDecision`.
-   **`CLEAR_CURRENT_DECISION`**: Clears the `currentDecision` property in the `NarrativeState`.

## Integration

The Player Decision Tracking System integrates with other parts of the application as follows:

-   **`NarrativeContext`**: The `NarrativeContext` stores the `decisionHistory`, `activeDecision`, and `pendingDecisions`.
-   **`NarrativeState`**: The `NarrativeState` stores the `currentDecision`.
-   **`narrativeReducer`**: The reducer handles actions to manage the decision-related state.
-   **AI Response Processing (Future Enhancement)**: The system is designed to be integrated with the AI response processing to both extract decision points from AI-generated text and to provide decision history as context for AI generation.

## Future Enhancements

-   **Decision Extraction from AI Responses:** Automatically identify decision points in AI-generated narrative.
-   **Dynamic Relevance Scoring:** Adjust relevance scores based on narrative context and player actions.
-   **Decision Visualization:** Create a UI component to visualize important past decisions.
-   **Decision Consequences:** Implement a more sophisticated system for tracking the long-term consequences of decisions.