---
title: Action Suggestion Logic
tags: [ai, suggestions, validation, diversification]
created: 2025-04-04
updated: 2025-04-04
---

# Action Suggestion Logic

This document outlines the process for validating and enhancing the suggested actions provided by the AI Game Master. The goal is to ensure a diverse set of essential action types are presented while prioritizing the preservation of unique, contextually relevant text generated by the AI.

## Core Flow (`gameService.ts` -> `responseValidator.ts`)

1.  **AI Response:** The `getAIResponse` function in `gameService.ts` receives the raw JSON response from the AI model.
2.  **Initial Parsing & Validation:** Basic parsing and validation occur in `gameService.ts` (checking for valid JSON, valid location types).
3.  **Enhancement Call:** If initial parsing is successful, `gameService.ts` calls `validateAndEnhanceResponse` from `responseValidator.ts`.
4.  **`validateAndEnhanceResponse` Logic:**
    *   Ensures the `suggestedActions` array exists on the response object.
    *   Calls `ensureDiverseActionTypes` to modify the *types* of the existing actions provided by the AI, preserving the original AI-generated text (`title`, `description`).
    *   Performs final validation checks (e.g., ensuring `playerDecision` has enough options, defaulting `opponent` to `null`).
    *   Returns the enhanced response object.
5.  **Fallback Action Addition Removed:** The logic previously responsible for adding template-based fallback actions if the AI provided fewer than 4 has been removed from `validateAndEnhanceResponse` to prioritize AI-generated text. The system now accepts that fewer than 4 actions may sometimes be presented.
6.  **`ensureDiverseActionTypes` Logic:**
    *   Identifies essential action types (`main`, `side`, `combat`, `interaction`) missing from the provided list.
    *   If types are missing, it attempts to replace the types of existing actions to fulfill the requirements.
    *   Replacement prioritizes: 'optional' types -> duplicate types -> non-essential types ('basic', 'chaotic', 'danger') -> other essential types (last resort).
    *   Crucially, this function **only modifies the `type` property**, preserving the original action text.

## Key Principles

*   **Prioritize AI Text:** The system avoids replacing action text generated by the AI whenever possible.
*   **Ensure Essential Types:** The `ensureDiverseActionTypes` function attempts to ensure 'main', 'side', 'combat', and 'interaction' actions are represented by modifying existing action types.
*   **No Minimum Action Guarantee:** The system no longer artificially adds actions to meet a minimum count (e.g., 4). The number of actions displayed directly reflects what the AI provided after type diversification.
*   **Template Fallback:** Template-based text generation (`generateContextAwareActionText`) is now primarily used by the `fallbackService.ts` when the entire AI call fails or times out, or potentially in specific error recovery scenarios within initialization hooks.

## Related Files

*   `BootHillGMApp/app/services/ai/utils/responseValidator.ts`
*   `BootHillGMApp/app/services/ai/gameService.ts`
*   `BootHillGMApp/app/hooks/initialization/useInitializationStrategies.ts`